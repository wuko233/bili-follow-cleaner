name: Build and Release EXE

# 触发条件：当你推送类似 v1.0, v2.3.1 这样的 tag 时触发
on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 安装 Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12" 

    # 3. 安装依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # 再次确保 pyinstaller 安装了
        pip install pyinstaller

    # 4. 运行你的打包脚本
    - name: Run Build Script
      env: 
        PYTHONIOENCODING: utf-8
      run: |
        python build.py

    # 5. (可选) 将 dist 目录下的 exe 打包成 zip
    # 这样用户下载更方便，也更不容易被浏览器拦截
    - name: Zip release
      run: |
        cd dist
        Compress-Archive -Path BiliCleaner_Terminal.exe -DestinationPath BiliCleaner_Terminal.zip
        Compress-Archive -Path BiliCleaner_WebUI.exe -DestinationPath BiliCleaner_WebUI.zip

    # 6. 创建 GitHub Release 并上传文件
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        # 这里指定要上传的文件
        files: |
          dist/BiliCleaner_Terminal.exe
          dist/BiliCleaner_WebUI.exe
          dist/BiliCleaner_Terminal.zip
          dist/BiliCleaner_WebUI.zip
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: false
        prerelease: false
